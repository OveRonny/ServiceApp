@page "/consumptionrecord/{id:int}"
@page "/consumptionrecord"
@page "/consumptionrecord/create/vehicle/{vehicleId:int}"
@using ServiceApp.UI.Shared.Utilities
@inject IConsumptionRecordService ConsumptionRecordService
@inject NavigationManager NavigationManager
@attribute [Authorize]

<h3>Forbruk</h3>

<EditForm Model="consumptionRecord" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />

    <div class="mb-3">
        <VehicleDropdown @bind-SelectedVehicleId="consumptionRecord.VehicleId" />
    </div>

    <div class="mb-3">
        <label for="date" class="form-label" >Dato</label>
        <InputDate id="date" class="form-control" @bind-Value="consumptionRecord.Date" />
        <ValidationMessage For="@(() => consumptionRecord.Date)" />
    </div>
    <div class="mb-3">
        <label for="dieselAdded" class="form-label">Antall liter</label>
        <InputText id="dieselAdded" class="form-control" @bind-Value="dieselAddedInput" />
        @if (!string.IsNullOrEmpty(dieselAddedError))
        {
            <div class="text-danger">@dieselAddedError</div>
        }
        <ValidationMessage For="@(() => consumptionRecord.DieselAdded)" />
    </div>

    <div class="mb-3">
        <label for="DieselPricePerLiter" class="form-label">Pris</label>
        <InputText id="DieselPricePerLiter" class="form-control" @bind-Value="priceInput" />
        @if (!string.IsNullOrEmpty(priceError))
        {
            <div class="text-danger">@priceError</div>
        }
        <ValidationMessage For="@(() => consumptionRecord.DieselPricePerLiter)" />
    </div>
    <div class="mb-3">
        <label for="Mileage" class="form-label">Kilometer</label>
        <InputNumber id="Mileage" class="form-control" @bind-Value="consumptionRecord.Mileage" />
        <ValidationMessage For="@(() => consumptionRecord.Mileage)" />
    </div>

    <button type="submit" class="btn btn-primary">Lagre</button>
    <button type="button" class="btn btn-secondary" @onclick="Cancel">Avbryt</button>
    @if (Id > 0)
    {
        <button type="button" class="btn btn-danger" @onclick="DeleteConsumption">Slett</button>
    }  

</EditForm>

@code {
    [Parameter]
    public int Id { get; set; }

    [Parameter]
    public int VehicleId { get; set; }

    private ConsumptionRecordModel consumptionRecord = new ConsumptionRecordModel();

    private string? dieselAddedError;
    private string? priceError;

    private static string FormatDecimal(decimal v) =>
        v == 0 ? string.Empty : v.ToString("G", System.Globalization.CultureInfo.CurrentCulture);

    private string dieselAddedInput
    {
        get => FormatDecimal(consumptionRecord.DieselAdded);
        set
        {
            if (NumberParsing.TryParseDecimal(value, out var parsed, out var err))
            {
                dieselAddedError = null;
                consumptionRecord.DieselAdded = parsed;
            }
            else
            {
                dieselAddedError = err;
            }
        }
    }

    private string priceInput
    {
        get => FormatDecimal(consumptionRecord.DieselPricePerLiter);
        set
        {
            if (NumberParsing.TryParseDecimal(value, out var parsed, out var err))
            {
                priceError = null;
                consumptionRecord.DieselPricePerLiter = parsed;
            }
            else
            {
                priceError = err;
            }
        }
    }


    protected override async Task OnInitializedAsync()
    {
        if (Id > 0)
        {            
            var result  = await ConsumptionRecordService.GetConsumptionRecordByIdAsync(Id);
            if (result != null)
            {
                consumptionRecord = result;
			}
        }
        else if (VehicleId > 0)
        {            
            consumptionRecord.VehicleId = VehicleId;
        }
        else
        {            
            consumptionRecord = new ConsumptionRecordModel();
        }
    }

    private async Task HandleValidSubmit()
    {
        if (!string.IsNullOrEmpty(dieselAddedError))
            return;
        if (Id > 0)
        {
            await ConsumptionRecordService.UpdateConsumptionRecordAsync(consumptionRecord);
        }
        else
        {
            await ConsumptionRecordService.CreateConsumptionRecordAsync(consumptionRecord);
        }
       
        NavigatToConsumptionRecords();
    }

    private async Task DeleteConsumption()
    {
        if (Id > 0)
        {
            await ConsumptionRecordService.DeleteConsumptionRecordAsync(Id);
            NavigatToConsumptionRecords();
        }
    }

    private void Cancel()
    {
        NavigatToConsumptionRecords();
    }

    private void NavigatToConsumptionRecords()
    {
        VehicleId = consumptionRecord.VehicleId;
        NavigationManager.NavigateTo($"/consumptionrecords/{VehicleId}");
    }

}
