@page "/servicerecord/{id:int}"
@page "/servicerecord/create/{vehicleId:int}"
@page "/servicerecord/create"
@inject IServiceRecordService ServiceRecordService
@inject IImageUploadService ImageUploadService
@inject NavigationManager NavigationManager
@attribute [Authorize]

<h3>Service</h3>

<div class="mb-3">
    <ServiceRecordForm Id="Id"
                       OnServiceRecordDeleted="RequestDelete"
                       OnServiceRecordSaved="HandleValidSubmit"
                       serviceRecord="serviceRecord" />
</div>

<ServiceRecordImages ImageIds="imageIds"
                     ImageSasUrls="imageSasUrls"
                     OnFileSelected="OnInputFileChange" />

<ConfirmModal TContext="ServiceRecordModel"
              Show="@showDelete"
              ShowChanged="@(v => showDelete = v)"
              Title="Slette service?"
              ConfirmText="Slett"
              CancelText="Avbryt"
              Danger="true"
              Icon="<i class='bi bi-trash-fill text-danger'></i>"
              Context="serviceRecord"
              OnConfirm="ConfirmDeleteAsync"
              OnCancel="CancelDelete"
              Size="sm"
              ContextRenderer="DeleteContextFragment" />

@code {
    private IBrowserFile? selectedFile;
    private ServiceRecordModel serviceRecord = new();
    private List<int>? imageIds;
    private VehicleInventoryModel? selectedInventory;
    private decimal addQuantity = 1m;
    private Dictionary<int, string> imageSasUrls = new();

    [Parameter] public int VehicleId { get; set; }
    [Parameter] public int Id { get; set; }

    private bool showDelete;
    private bool deleting;

    // Move inline lambda + markup into a RenderFragment<T> property to avoid
    // "Component attributes do not support complex content" error.
    private RenderFragment<ServiceRecordModel> DeleteContextFragment => r => @<div>
        <p>Du er i ferd med å slette service <strong>#@r.Id</strong> (@r.ServiceDate.ToShortDateString()).</p>
        <p class="mb-0 text-danger">Denne handlingen kan ikke angres.</p>
    </div>;

    protected override async Task OnParametersSetAsync()
    {
        if (Id > 0)
        {
            serviceRecord = await ServiceRecordService.GetServiceRecordByIdAsync(Id);
            await GetImageIds();

            if (serviceRecord.Parts is { Count: > 0 })
            {
                serviceRecord.UsedParts = serviceRecord.Parts
                    .Where(p => p.VehicleInventoryId.HasValue)
                    .Select(p => new UsedPartModel
                    {
                        RowId = Guid.NewGuid(),
                        VehicleInventoryId = p.VehicleInventoryId,
                        Quantity = Math.Max(1, p.Quantity),
                        UnitCost = p.Price,
                        Description = p.Description,
                        Name = p.Name
                    })
                    .ToList();
            }
        }
        else
        {
            serviceRecord = new ServiceRecordModel();
            if (VehicleId > 0) serviceRecord.VehicleId = VehicleId;
        }

        selectedInventory = null;
        addQuantity = 1m;
        RecalcCost();
    }

    private async Task GetImageIds()
    {
        imageIds = await ServiceRecordService.GetServiceRecordImageIdsAsync(Id);
        imageSasUrls = imageIds != null
            ? await ServiceRecordService.GetImageSasUrlsAsync(imageIds)
            : new Dictionary<int, string>();
    }

    private void OnUsedPartQuantityChanged()
    {
        foreach (var p in serviceRecord.UsedParts)
            if (p.Quantity <= 0) p.Quantity = 1m;
        RecalcCost();
    }

    private decimal CalculatedPartsTotal()
        => serviceRecord.UsedParts
            .Where(p => p.UnitCost.HasValue && p.Quantity > 0)
            .Sum(p => p.UnitCost!.Value * p.Quantity);

    private void RecalcCost()
    {
        var partsTotal = CalculatedPartsTotal();
        if (partsTotal > 0) serviceRecord.Cost = partsTotal;
    }

    private async Task HandleValidSubmit()
    {
        serviceRecord.UsedParts = serviceRecord.UsedParts
            .Where(p => p.VehicleInventoryId is int && p.Quantity > 0)
            .ToList();

        if (Id > 0)
        {
            if (selectedFile != null)
                await ServiceRecordService.UpdateServiceRecordWithImageAsync(serviceRecord, selectedFile);
            else
                await ServiceRecordService.UpdateServiceRecordAsync(serviceRecord);
        }
        else
        {
            if (selectedFile != null)
                await ServiceRecordService.CreateServiceRecordWithImageAsync(serviceRecord, selectedFile);
            else
                await ServiceRecordService.CreateServiceRecordAsync(serviceRecord);
        }

        NavigateToServiceRecords();
    }

    private Task RequestDelete()
    {
        if (Id <= 0) return Task.CompletedTask;
        showDelete = true;
        return Task.CompletedTask;
    }

    private async Task ConfirmDeleteAsync(ServiceRecordModel? _)
    {
        if (Id <= 0) { showDelete = false; return; }
        deleting = true;
        try
        {
            await ServiceRecordService.DeleteServiceRecordAsync(Id);
            NavigateToServiceRecords();
        }
        finally
        {
            deleting = false;
            showDelete = false;
        }
    }

    private Task CancelDelete(ServiceRecordModel? _)
    {
        showDelete = false;
        return Task.CompletedTask;
    }

    private async Task DeleteServiceRecord()
    {
        if (Id > 0)
        {
            await ServiceRecordService.DeleteServiceRecordAsync(Id);
            NavigateToServiceRecords();
        }
    }

    private void NavigateToServiceRecords()
    {
        var vid = serviceRecord.VehicleId;
        NavigationManager.NavigateTo($"/servicerecords/{vid}");
    }

    private void OnInputFileChange(InputFileChangeEventArgs e)
        => selectedFile = e.File;
}